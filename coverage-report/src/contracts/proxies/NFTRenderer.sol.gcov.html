<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - current.info - src/contracts/proxies/NFTRenderer.sol</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">src/contracts/proxies</a> - NFTRenderer.sol<span style="font-size: 80%;"> (source / <a href="NFTRenderer.sol.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">current.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">120</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2024-01-07 16:13:44</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : // SPDX-License-Identifier: GPL-3.0</a>
<span class="lineNum">       2 </span>            : pragma solidity 0.8.19;
<span class="lineNum">       3 </span>            : 
<span class="lineNum">       4 </span>            : import {DateTime} from '@libraries/DateTime.sol';
<span class="lineNum">       5 </span>            : import {Strings} from '@openzeppelin/utils/Strings.sol';
<span class="lineNum">       6 </span>            : import {Base64} from '@openzeppelin/utils/Base64.sol';
<span class="lineNum">       7 </span>            : import {Math} from '@libraries/Math.sol';
<span class="lineNum">       8 </span>            : import {IVault721} from '@interfaces/proxies/IVault721.sol';
<span class="lineNum">       9 </span>            : import {IODSafeManager} from '@interfaces/proxies/IODSafeManager.sol';
<span class="lineNum">      10 </span>            : import {ISAFEEngine} from '@interfaces/ISAFEEngine.sol';
<span class="lineNum">      11 </span>            : import {IOracleRelayer} from '@interfaces/IOracleRelayer.sol';
<span class="lineNum">      12 </span>            : import {IDelayedOracle} from '@interfaces/oracles/IDelayedOracle.sol';
<span class="lineNum">      13 </span>            : import {ITaxCollector} from '@interfaces/ITaxCollector.sol';
<span class="lineNum">      14 </span>            : import {ICollateralJoinFactory} from '@interfaces/factories/ICollateralJoinFactory.sol';
<span class="lineNum">      15 </span>            : import {ICollateralJoin} from '@interfaces/utils/ICollateralJoin.sol';
<span class="lineNum">      16 </span>            : import {IERC20Metadata} from '@openzeppelin/token/ERC20/extensions/IERC20Metadata.sol';
<span class="lineNum">      17 </span>            : 
<span class="lineNum">      18 </span>            : //console import
<span class="lineNum">      19 </span>            : import 'forge-std/console2.sol';
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : contract NFTRenderer {
<span class="lineNum">      22 </span>            :   using Strings for uint256;
<span class="lineNum">      23 </span>            :   using Math for uint256;
<span class="lineNum">      24 </span>            :   using DateTime for uint256;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            :   uint256 internal constant _RAY = 10 ** 27;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            :   IVault721 public immutable vault721;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            :   // protocol contracts
<span class="lineNum">      31 </span>            :   IODSafeManager internal _safeManager;
<span class="lineNum">      32 </span>            :   ISAFEEngine internal _safeEngine;
<span class="lineNum">      33 </span>            :   IOracleRelayer internal _oracleRelayer;
<span class="lineNum">      34 </span>            :   ITaxCollector internal _taxCollector;
<span class="lineNum">      35 </span>            :   ICollateralJoinFactory internal _collateralJoinFactory;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            :   constructor(address _vault721, address oracleRelayer, address taxCollector, address collateralJoinFactory) {
<span class="lineNum">      38 </span>            :     vault721 = IVault721(_vault721);
<span class="lineNum">      39 </span>            :     vault721.initializeRenderer();
<span class="lineNum">      40 </span>            :     _safeManager = IODSafeManager(vault721.safeManager());
<span class="lineNum">      41 </span>            :     _safeEngine = ISAFEEngine(_safeManager.safeEngine());
<span class="lineNum">      42 </span>            :     _oracleRelayer = IOracleRelayer(oracleRelayer);
<span class="lineNum">      43 </span>            :     _taxCollector = ITaxCollector(taxCollector);
<span class="lineNum">      44 </span>            :     _collateralJoinFactory = ICollateralJoinFactory(collateralJoinFactory);
<span class="lineNum">      45 </span>            :   }
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            :   struct VaultParams {
<span class="lineNum">      48 </span>            :     uint256 ratio;
<span class="lineNum">      49 </span>            :     string collateral;
<span class="lineNum">      50 </span>            :     string debt;
<span class="lineNum">      51 </span>            :     string metaCollateral;
<span class="lineNum">      52 </span>            :     string metaDebt;
<span class="lineNum">      53 </span>            :     string vaultId;
<span class="lineNum">      54 </span>            :     string stabilityFee;
<span class="lineNum">      55 </span>            :     string symbol;
<span class="lineNum">      56 </span>            :     string risk;
<span class="lineNum">      57 </span>            :     string color;
<span class="lineNum">      58 </span>            :     string stroke;
<span class="lineNum">      59 </span>            :     string lastUpdate;
<span class="lineNum">      60 </span>            :     string stateHash;
<span class="lineNum">      61 </span>            :   }
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            :   /**
<a name="64"><span class="lineNum">      64 </span>            :    * @dev upgradeability permissioned to governor via Vault721</a>
<span class="lineNum">      65 </span>            :    */
<span class="lineNum">      66 </span>            :   function setImplementation(
<span class="lineNum">      67 </span>            :     address safeManager,
<span class="lineNum">      68 </span>            :     address oracleRelayer,
<span class="lineNum">      69 </span>            :     address taxCollector,
<span class="lineNum">      70 </span>            :     address collateralJoinFactory
<span class="lineNum">      71 </span>            :   ) external {
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     require(msg.sender == address(vault721), 'NFT: only vault721');</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :     _safeManager = IODSafeManager(safeManager);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     _safeEngine = ISAFEEngine(_safeManager.safeEngine());</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     _oracleRelayer = IOracleRelayer(oracleRelayer);</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :     _taxCollector = ITaxCollector(taxCollector);</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :     _collateralJoinFactory = ICollateralJoinFactory(collateralJoinFactory);</span>
<span class="lineNum">      78 </span>            :   }
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span>            :   /**
<span class="lineNum">      81 </span>            :    * @dev render json object with NFT description and image
<a name="82"><span class="lineNum">      82 </span>            :    * @notice svg needs to be broken into separate functions to reduce call stack for compilation</a>
<span class="lineNum">      83 </span>            :    */
<span class="lineNum">      84 </span>            :   function render(uint256 _safeId) external view returns (string memory uri) {
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :     VaultParams memory params = renderParams(_safeId);</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     string memory text = _renderText(params);</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :     uint256 ratio = params.ratio;</span>
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :     string memory json = string.concat(</span>
<span class="lineNum">      90 </span>            :       '{&quot;name&quot;:&quot;OD NFV #',
<span class="lineNum">      91 </span>            :       text,
<span class="lineNum">      92 </span>            :       '&quot;}],&quot;image&quot;:&quot;data:image/svg+xml;base64,',
<span class="lineNum">      93 </span>            :       Base64.encode(
<span class="lineNum">      94 </span>            :         bytes(
<span class="lineNum">      95 </span>            :           string.concat(
<span class="lineNum">      96 </span>            :             _renderVaultInfo(params.vaultId, params.color),
<span class="lineNum">      97 </span>            :             _renderCollatAndDebt(
<span class="lineNum">      98 </span>            :               ratio, params.stabilityFee, params.debt, params.collateral, params.symbol, params.lastUpdate
<span class="lineNum">      99 </span>            :             ),
<span class="lineNum">     100 </span>            :             _renderRisk(ratio, params.stroke, params.risk),
<span class="lineNum">     101 </span>            :             _renderBackground(params.color)
<span class="lineNum">     102 </span>            :           )
<span class="lineNum">     103 </span>            :         )
<span class="lineNum">     104 </span>            :       ),
<span class="lineNum">     105 </span>            :       '&quot;}'
<span class="lineNum">     106 </span>            :     );
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :     uri = string.concat('data:application/json;base64,', Base64.encode(bytes(json)));</span>
<span class="lineNum">     109 </span>            :   }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            :   /**
<span class="lineNum">     112 </span>            :    * @dev gets the vault ctype, collateral and debt amounts given `_safeId`
<span class="lineNum">     113 </span>            :    * @param _safeId vault id
<span class="lineNum">     114 </span>            :    * @return cType collateral type
<span class="lineNum">     115 </span>            :    * @return collateral collateral amount for safe with `_safeId`
<a name="116"><span class="lineNum">     116 </span>            :    * @return debt debt amount for safe with `_safeId`</a>
<span class="lineNum">     117 </span>            :    */
<span class="lineNum">     118 </span>            :   function getVaultCTypeAndCollateralAndDebt(uint256 _safeId)
<span class="lineNum">     119 </span>            :     public
<span class="lineNum">     120 </span>            :     view
<span class="lineNum">     121 </span>            :     returns (bytes32 cType, uint256 collateral, uint256 debt)
<span class="lineNum">     122 </span>            :   {
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     IODSafeManager.SAFEData memory safeMangerData = _safeManager.safeData(_safeId);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     address safeHandler = safeMangerData.safeHandler;</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     cType = safeMangerData.collateralType;</span>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     ISAFEEngine.SAFE memory SafeEngineData = _safeEngine.safes(cType, safeHandler);</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     collateral = SafeEngineData.lockedCollateral;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     debt = SafeEngineData.generatedDebt;</span>
<span class="lineNum">     130 </span>            :   }
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span>            :   /**
<span class="lineNum">     133 </span>            :    * @dev computes the current state hash based on the state for a vault given `_safeId`
<span class="lineNum">     134 </span>            :    * @param _safeId vault id
<a name="135"><span class="lineNum">     135 </span>            :    * @return stateHash state hash for safe with `_safeId`</a>
<span class="lineNum">     136 </span>            :    */
<span class="lineNum">     137 </span>            :   function getStateHashBySafeId(uint256 _safeId) external view returns (bytes32 stateHash) {
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     (, uint256 collateral, uint256 debt) = getVaultCTypeAndCollateralAndDebt(_safeId);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     stateHash = getStateHash(collateral, debt);</span>
<span class="lineNum">     140 </span>            :   }
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span>            :   /**
<span class="lineNum">     143 </span>            :    * @dev computes the current state hash given `_collateral` and `_debt`
<span class="lineNum">     144 </span>            :    * @param _collateral collateral amount
<span class="lineNum">     145 </span>            :    * @param _debt debt amount
<a name="146"><span class="lineNum">     146 </span>            :    * @return stateHash computed state hash</a>
<span class="lineNum">     147 </span>            :    */
<span class="lineNum">     148 </span>            :   function getStateHash(uint256 _collateral, uint256 _debt) public pure returns (bytes32 stateHash) {
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     stateHash = keccak256(abi.encode(_collateral, _debt));</span>
<span class="lineNum">     150 </span>            :   }
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :   /**
<a name="153"><span class="lineNum">     153 </span>            :    * @dev reads from various protocol contracts to collect data about user vaults by vault id</a>
<span class="lineNum">     154 </span>            :    */
<span class="lineNum">     155 </span>            :   function renderParams(uint256 _safeId) public view returns (VaultParams memory) {
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     VaultParams memory params;</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     params.vaultId = _safeId.toString();</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     bytes32 cType;</span>
<span class="lineNum">     160 </span>            :     // scoped to reduce call stack
<span class="lineNum">     161 </span>            :     {
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :       uint256 collateral;</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :       uint256 debt;</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :       (cType, collateral, debt) = getVaultCTypeAndCollateralAndDebt(_safeId);</span>
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :       IOracleRelayer.OracleRelayerCollateralParams memory oracleParams = _oracleRelayer.cParams(cType);</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :       IDelayedOracle oracle = oracleParams.oracle;</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :       uint256 safetyCRatio = oracleParams.safetyCRatio / 10e24;</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :       uint256 liquidationCRatio = oracleParams.liquidationCRatio / 10e24;</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :       uint256 ratio;</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :       if (collateral != 0 &amp;&amp; debt != 0) {</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :         ISAFEEngine.SAFEEngineCollateralData memory cTypeData = _safeEngine.cData(cType);</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :         console2.log(collateral, debt);</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :         ratio = ((collateral.wmul(oracle.read())).wdiv(debt.wmul(cTypeData.accumulatedRate))) / 1e7; // _RAY to _WAD conversion</span>
<span class="lineNum">     176 </span>            :       } else {
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :         ratio = 0;</span>
<span class="lineNum">     178 </span>            :       }
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       IERC20Metadata token = ICollateralJoin(_collateralJoinFactory.collateralJoins(cType)).collateral();</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       params.symbol = token.symbol();</span>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span>            :       {
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :         (uint256 left, uint256 right) = _floatingPoint(debt);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :         params.debt = _parseNumberWithComma(left, right);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         params.metaDebt = _parseNumber(left, right);</span>
<span class="lineNum">     187 </span>            :       }
<span class="lineNum">     188 </span>            :       {
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         (uint256 left, uint256 right) = _floatingPoint(collateral);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         params.collateral = _parseNumberWithComma(left, right);</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         params.metaCollateral = _parseNumber(left, right);</span>
<span class="lineNum">     192 </span>            :       }
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :       params.lastUpdate = _formatDateTime(oracle.lastUpdateTime());</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :       (params.risk, params.color) = _calcRisk(ratio, liquidationCRatio, safetyCRatio);</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :       params.stroke = _calcStroke(ratio);</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :       params.ratio = ratio;</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :       params.stateHash = string(abi.encodePacked(getStateHash(collateral, debt)));</span>
<span class="lineNum">     200 </span>            :     }
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     ITaxCollector.TaxCollectorCollateralData memory taxData = _taxCollector.cData(cType);</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     params.stabilityFee = (taxData.nextStabilityFee / _RAY).toString();</span>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     return params;</span>
<span class="lineNum">     206 </span>            :   }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span>            :   /**
<a name="209"><span class="lineNum">     209 </span>            :    * @dev json text</a>
<span class="lineNum">     210 </span>            :    */
<span class="lineNum">     211 </span>            :   function _renderText(VaultParams memory params) internal pure returns (string memory text) {
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     string memory desc = _renderDesc(params.vaultId);</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     string memory traits = _renderTraits(params);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     text = string.concat(</span>
<span class="lineNum">     215 </span>            :       params.vaultId,
<span class="lineNum">     216 </span>            :       '&quot;,&quot;description&quot;:',
<span class="lineNum">     217 </span>            :       desc,
<span class="lineNum">     218 </span>            :       '&quot;attributes&quot;:[{&quot;trait_type&quot;:&quot;ID&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     219 </span>            :       params.vaultId,
<span class="lineNum">     220 </span>            :       traits,
<span class="lineNum">     221 </span>            :       params.lastUpdate
<span class="lineNum">     222 </span>            :     );
<span class="lineNum">     223 </span>            :   }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span>            :   /**
<a name="226"><span class="lineNum">     226 </span>            :    * @dev json description</a>
<span class="lineNum">     227 </span>            :    */
<span class="lineNum">     228 </span>            :   function _renderDesc(string memory _safeId) internal pure returns (string memory desc) {
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     desc = string.concat(</span>
<span class="lineNum">     230 </span>            :       '&quot;Non-Fungible Vault #',
<span class="lineNum">     231 </span>            :       _safeId,
<span class="lineNum">     232 </span>            :       ' Caution! Trading this NFV gives the recipient full ownership of your Vault, including all collateral &amp; debt obligations. This act is irreversible.&quot;,'
<span class="lineNum">     233 </span>            :     );
<span class="lineNum">     234 </span>            :   }
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :   /**
<a name="237"><span class="lineNum">     237 </span>            :    * @dev json attributes</a>
<span class="lineNum">     238 </span>            :    */
<span class="lineNum">     239 </span>            :   function _renderTraits(VaultParams memory params) internal pure returns (string memory traits) {
<span class="lineNum">     240 </span>            :     // stack at 16 slot max w/ 32-byte+ strings
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     traits = string.concat(</span>
<span class="lineNum">     242 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Debt&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     243 </span>            :       params.metaDebt,
<span class="lineNum">     244 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Collateral&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     245 </span>            :       params.metaCollateral,
<span class="lineNum">     246 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Collateral Type&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     247 </span>            :       params.symbol,
<span class="lineNum">     248 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Stability Fee&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     249 </span>            :       params.stabilityFee,
<span class="lineNum">     250 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Risk&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     251 </span>            :       params.risk,
<span class="lineNum">     252 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Collateral Ratio&quot;,&quot;value&quot;:&quot;',
<span class="lineNum">     253 </span>            :       params.ratio.toString(),
<span class="lineNum">     254 </span>            :       '&quot;},{&quot;trait_type&quot;:&quot;Last Updated&quot;,&quot;value&quot;:&quot;'
<span class="lineNum">     255 </span>            :     );
<span class="lineNum">     256 </span>            :   }
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            :   /**
<a name="259"><span class="lineNum">     259 </span>            :    * @dev svg vault/token id</a>
<span class="lineNum">     260 </span>            :    */
<span class="lineNum">     261 </span>            :   function _renderVaultInfo(string memory vaultId, string memory color) internal pure returns (string memory svg) {
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :     svg = string.concat(</span>
<span class="lineNum">     263 </span>            :       '&lt;svg width=&quot;420&quot; height=&quot;420&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://app.dev.opendollar.com/#/vaults/',
<span class="lineNum">     264 </span>            :       vaultId,
<span class="lineNum">     265 </span>            :       '&quot;&gt;&lt;style&gt;.graph-bg { fill: none; stroke: #000; stroke-width: 20; opacity: 80%;} .graph {fill: none; stroke-width: 20; stroke-linecap: flat; animation: progress 1s ease-out forwards;} .chart {stroke: ',
<span class="lineNum">     266 </span>            :       color,
<span class="lineNum">     267 </span>            :       ';opacity: 40%;} .risk-ratio {fill: ',
<span class="lineNum">     268 </span>            :       color,
<span class="lineNum">     269 </span>            :       ';}@keyframes progress {0% {stroke-dasharray: 0 1005;}} @keyframes liquidation {0% {  opacity: 80%;} 50% {  opacity: 20%;} 100 {  opacity: 80%;}}&lt;/style&gt;&lt;g font-family=&quot;Inter, Verdana, sans-serif&quot; style=&quot;white-space:pre&quot; font-size=&quot;12&quot;&gt;&lt;path fill=&quot;#001828&quot; d=&quot;M0 0H420V420H0z&quot; /&gt;&lt;path fill=&quot;url(#gradient)&quot; d=&quot;M0 0H420V420H0z&quot; /&gt;&lt;path id=&quot;od-pattern-tile&quot; opacity=&quot;.05&quot; d=&quot;M49.7-40a145 145 0 1 0 0 290m0-290V8.2m0-48.4a145 145 0 1 1 0 290m0-241.6a96.7 96.7 0 1 0 0 193.3m0-193.3a96.7 96.7 0 1 1 0 193.3m0 0v48.3m0-96.6a48.3 48.3 0 0 0 0-96.7v96.7Zm0 0a48.3 48.3 0 0 1 0-96.7v96.7Z&quot; stroke=&quot;#fff&quot; /&gt;&lt;use xlink:href=&quot;#od-pattern-tile&quot; x=&quot;290&quot; /&gt;&lt;use xlink:href=&quot;#od-pattern-tile&quot; y=&quot;290&quot; /&gt;&lt;use xlink:href=&quot;#od-pattern-tile&quot; x=&quot;290&quot; y=&quot;290&quot; /&gt;&lt;use xlink:href=&quot;#od-pattern-tile&quot; x=&quot;193&quot; y=&quot;145&quot; /&gt;&lt;text fill=&quot;#00587E&quot; xml:space=&quot;preserve&quot;&gt;&lt;tspan x=&quot;24&quot; y=&quot;40.7&quot;&gt;VAULT ID&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#1499DA&quot; xml:space=&quot;preserve&quot; font-size=&quot;22&quot;&gt;&lt;tspan x=&quot;24&quot; y=&quot;65&quot;&gt;',
<span class="lineNum">     270 </span>            :       vaultId,
<span class="lineNum">     271 </span>            :       '&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#00587E&quot; xml:space=&quot;preserve&quot;&gt;&lt;tspan x=&quot;335.9&quot; y=&quot;40.7&quot;&gt;STABILITY&lt;/tspan&gt;&lt;tspan x=&quot;335.9&quot; y=&quot;54.7&quot;&gt;FEE&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#1499DA&quot; xml:space=&quot;preserve&quot; font-size=&quot;22&quot;&gt;&lt;tspan x=&quot;364&quot; y=&quot;63.3&quot;&gt;'
<span class="lineNum">     272 </span>            :     );
<span class="lineNum">     273 </span>            :   }
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            :   /**
<a name="276"><span class="lineNum">     276 </span>            :    * @dev svg collateral and debt data</a>
<span class="lineNum">     277 </span>            :    */
<span class="lineNum">     278 </span>            :   function _renderCollatAndDebt(
<span class="lineNum">     279 </span>            :     uint256 ratio,
<span class="lineNum">     280 </span>            :     string memory stabilityFee,
<span class="lineNum">     281 </span>            :     string memory debt,
<span class="lineNum">     282 </span>            :     string memory collateral,
<span class="lineNum">     283 </span>            :     string memory symbol,
<span class="lineNum">     284 </span>            :     string memory lastUpdate
<span class="lineNum">     285 </span>            :   ) internal pure returns (string memory svg) {
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     string memory debtDetail;</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     if (ratio != 0) {</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :       debtDetail = string.concat(</span>
<span class="lineNum">     289 </span>            :         '&lt;text fill=&quot;#00587E&quot; xml:space=&quot;preserve&quot; font-weight=&quot;600&quot;&gt;&lt;tspan x=&quot;102&quot; y=&quot;168.9&quot;&gt;DEBT MINTED&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#D0F1FF&quot; xml:space=&quot;preserve&quot; font-size=&quot;24&quot;&gt;&lt;tspan x=&quot;102&quot; y=&quot;194&quot;&gt;',
<span class="lineNum">     290 </span>            :         debt,
<span class="lineNum">     291 </span>            :         ' OD',
<span class="lineNum">     292 </span>            :         '&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#00587E&quot; xml:space=&quot;preserve&quot; font-weight=&quot;600&quot;&gt;&lt;tspan x=&quot;102&quot; y=&quot;229.9&quot;&gt;COLLATERAL DEPOSITED&lt;/tspan&gt;&lt;/text&gt;&lt;text fill=&quot;#D0F1FF&quot; xml:space=&quot;preserve&quot; font-size=&quot;24&quot;&gt;&lt;tspan x=&quot;102&quot; y=&quot;255&quot;&gt;',
<span class="lineNum">     293 </span>            :         collateral,
<span class="lineNum">     294 </span>            :         ' ',
<span class="lineNum">     295 </span>            :         symbol,
<span class="lineNum">     296 </span>            :         '&lt;/tspan&gt;&lt;/text&gt;&lt;text opacity=&quot;.3&quot; transform=&quot;rotate(-90 326.5 -58.5)&quot; fill=&quot;#fff&quot; xml:space=&quot;preserve&quot; font-size=&quot;10&quot;&gt;&lt;tspan x=&quot;-10.3&quot; y=&quot;7.3&quot;&gt;Updated '
<span class="lineNum">     297 </span>            :       );
<span class="lineNum">     298 </span>            :     } else {
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :       debtDetail =</span>
<span class="lineNum">     300 </span>            :         '&lt;text fill=&quot;#63676F&quot; xml:space=&quot;preserve&quot; font-size=&quot;24&quot;&gt;&lt;tspan x=&quot;136&quot; y=&quot;210&quot;&gt;Zero Balance&lt;/tspan&gt;&lt;/text&gt;&lt;text opacity=&quot;.3&quot; transform=&quot;rotate(-90 326.5 -58.5)&quot; fill=&quot;#fff&quot; xml:space=&quot;preserve&quot; font-size=&quot;10&quot;&gt;&lt;tspan x=&quot;-10.3&quot; y=&quot;7.3&quot;&gt;Updated ';
<span class="lineNum">     301 </span>            :     }
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     svg = string.concat(</span>
<span class="lineNum">     303 </span>            :       stabilityFee,
<span class="lineNum">     304 </span>            :       '%&lt;/tspan&gt;&lt;/text&gt;&lt;text opacity=&quot;.3&quot; transform=&quot;rotate(90 -66.5 101.5)&quot; fill=&quot;#fff&quot; xml:space=&quot;preserve&quot; font-size=&quot;10&quot;&gt;&lt;tspan x=&quot;.5&quot; y=&quot;7.3&quot;&gt;opendollar.com&lt;/tspan&gt;&lt;/text&gt;',
<span class="lineNum">     305 </span>            :       debtDetail,
<span class="lineNum">     306 </span>            :       lastUpdate
<span class="lineNum">     307 </span>            :     );
<span class="lineNum">     308 </span>            :   }
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :   /**
<a name="311"><span class="lineNum">     311 </span>            :    * @dev svg risk data</a>
<span class="lineNum">     312 </span>            :    */
<span class="lineNum">     313 </span>            :   function _renderRisk(
<span class="lineNum">     314 </span>            :     uint256 ratio,
<span class="lineNum">     315 </span>            :     string memory stroke,
<span class="lineNum">     316 </span>            :     string memory risk
<span class="lineNum">     317 </span>            :   ) internal pure returns (string memory svg) {
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     string memory rectangle;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     string memory riskDetail;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     if (ratio != 0) {</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :       rectangle =</span>
<span class="lineNum">     322 </span>            :         '), 1005&quot; d=&quot;M210 40a160 160 0 0 1 0 320 160 160 0 0 1 0-320&quot; /&gt;&lt;/g&gt;&lt;g class=&quot;risk-ratio&quot;&gt;&lt;rect x=&quot;242&quot; y=&quot;306&quot; width=&quot;154&quot; height=&quot;82&quot; rx=&quot;8&quot; fill=&quot;#001828&quot; fill-opacity=&quot;.7&quot; /&gt;&lt;circle cx=&quot;243&quot; cy=&quot;326.5&quot; r=&quot;4&quot; /&gt;&lt;text xml:space=&quot;preserve&quot; font-weight=&quot;600&quot;&gt;&lt;tspan x=&quot;255&quot; y=&quot;330.7&quot;&gt;';
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :       riskDetail = string.concat(</span>
<span class="lineNum">     324 </span>            :         ' RISK&lt;/tspan&gt;&lt;/text&gt;&lt;text xml:space=&quot;preserve&quot;&gt;&lt;tspan x=&quot;255&quot; y=&quot;355.7&quot;&gt;COLLATERAL&lt;/tspan&gt;&lt;tspan x=&quot;255&quot; y=&quot;371.7&quot;&gt;RATIO ',
<span class="lineNum">     325 </span>            :         ratio.toString(),
<span class="lineNum">     326 </span>            :         '%&lt;/tspan&gt;&lt;/text&gt;'
<span class="lineNum">     327 </span>            :       );
<span class="lineNum">     328 </span>            :     } else {
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :       rectangle =</span>
<span class="lineNum">     330 </span>            :         '), 1005&quot; d=&quot;M210 40a160 160 0 0 1 0 320 160 160 0 0 1 0-320&quot; /&gt;&lt;/g&gt;&lt;g class=&quot;risk-ratio&quot;&gt;&lt;rect x=&quot;298&quot; y=&quot;350&quot; width=&quot;96&quot; height=&quot;40&quot; rx=&quot;8&quot; fill=&quot;#001828&quot; fill-opacity=&quot;.7&quot; /&gt;&lt;circle cx=&quot;299&quot; cy=&quot;370.5&quot; r=&quot;4&quot; /&gt;&lt;text xml:space=&quot;preserve&quot; font-weight=&quot;600&quot;&gt;&lt;tspan x=&quot;311&quot; y=&quot;374.7&quot;&gt;';
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       riskDetail = ' RISK&lt;/tspan&gt;&lt;/text&gt;';</span>
<span class="lineNum">     332 </span>            :     }
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     svg = string.concat(</span>
<span class="lineNum">     334 </span>            :       '&lt;/tspan&gt;&lt;/text&gt;&lt;g opacity=&quot;.6&quot;&gt;&lt;text fill=&quot;#fff&quot; xml:space=&quot;preserve&quot;&gt;&lt;tspan x=&quot;24&quot; y=&quot;387.4&quot;&gt;Powered by&lt;/tspan&gt;&lt;/text&gt;&lt;path d=&quot;M112.5 388c-2 0-3-1.2-3-3.2v-3.3c0-2 1-3.3 3-3.3 2.1 0 3.2 1.3 3.2 3.3v3.3c0 2-1 3.3-3.2 3.3Zm-1.5-3.2c0 1.1.5 1.8 1.6 1.8 1 0 1.5-.7 1.5-1.8v-3.3c0-1.1-.4-1.8-1.5-1.8s-1.6.7-1.6 1.8v3.3ZM117.3 390.6l-.1-.2V381l.1-.2h1.2l.1.2v.7c.3-.7 1-1 1.8-1 1.3 0 2 1 2 2.6v2.3c0 1.6-.8 2.6-2 2.6-.8 0-1.4-.4-1.7-1v3.3c0 .1 0 .2-.2.2h-1.2Zm1.4-5.2c0 .9.5 1.3 1.1 1.3.7 0 1-.5 1-1.3v-2.2c0-.7-.3-1.3-1-1.3-.6 0-1.1.5-1.1 1.4v2ZM126.2 388c-1.6 0-2.6-1-2.6-2.6v-2.2c0-1.6 1-2.6 2.5-2.6 1.6 0 2.6 1 2.6 2.6v1.4c0 .1 0 .2-.2.2h-3.4v.6c0 1 .4 1.4 1.1 1.4.6 0 1-.3 1.1-.8l.2-.2 1 .3c.1 0 .2 0 .1.2-.2 1-1 1.8-2.4 1.8Zm-1.1-4.2h2.2v-.7c0-.8-.4-1.3-1.1-1.3-.8 0-1.1.5-1.1 1.3v.7ZM130.2 388l-.2-.2v-7l.2-.1h1.1c.1 0 .2 0 .2.2v.7c.4-.7 1-1 1.7-1 1.1 0 1.8.8 1.8 2.5v4.7l-.1.1h-1.2l-.2-.1V383c0-.8-.3-1.2-.8-1.2s-1 .4-1.2 1v4.9l-.1.1h-1.2ZM136.8 388l-.2-.2v-9.3c0-.1 0-.2.2-.2h2.6c2 0 3.1 1.3 3.1 3.3v3c0 2-1 3.3-3.1 3.3h-2.6Zm1.4-1.5h1.2c1 0 1.6-.7 1.6-1.8v-3c0-1.2-.5-1.9-1.6-1.9h-1.2v6.7ZM146.4 388c-1.6 0-2.6-1-2.6-2.6v-2.2c0-1.6 1-2.6 2.6-2.6 1.7 0 2.6 1 2.6 2.6v2.2c0 1.7-1 2.7-2.6 2.7Zm-1-2.6c0 .9.3 1.3 1 1.3.8 0 1.1-.4 1.1-1.3v-2.2c0-.8-.4-1.3-1-1.3-.8 0-1.1.5-1.1 1.3v2.2ZM150.6 388l-.2-.2V378l.2-.2h1.2l.2.2v9.7l-.2.1h-1.2ZM153.7 388l-.2-.2V378c0-.1 0-.2.2-.2h1.2l.1.2v9.7l-.1.1h-1.2ZM160 388l-.1-.2v-.8c-.4.7-1 1-1.7 1-1.1 0-1.9-.7-1.9-2 0-1.4.7-2.3 2.6-2.3h1v-.8c0-.7-.4-1-1-1s-.8.2-1 .8h-.2l-1-.2c-.1 0-.2-.1-.1-.2.2-1 1-1.7 2.4-1.7 1.5 0 2.3.7 2.3 2.2v5l-.2.1h-1Zm-2.3-2.2c0 .7.3 1 1 1 .5 0 1-.3 1.1-1v-1.1h-.8c-.8 0-1.3.4-1.3 1.1ZM163 388l-.2-.2v-7h1.5v1c.3-.7.9-1.2 1.8-1.2.1 0 .2 0 .2.2v1.1c0 .1 0 .2-.2.2-1 0-1.5.3-1.8 1v4.7l-.1.1H163Z&quot; fill=&quot;#fff&quot; /&gt;&lt;path d=&quot;M97 383.2c0-2.7 2-4.8 4.7-4.8v1.6a3.2 3.2 0 0 0-3.1 3.2c0 1.8 1.4 3.2 3 3.2v1.6a4.7 4.7 0 0 1-4.6-4.8ZM101.7 384.8c.8 0 1.5-.7 1.5-1.6 0-.9-.7-1.6-1.5-1.6v3.2Z&quot; fill=&quot;#fff&quot; opacity=&quot;.5&quot; /&gt;&lt;path d=&quot;M106.3 383.2c0 2.7-2 4.8-4.6 4.8v-1.6c1.7 0 3-1.4 3-3.2 0-1.8-1.3-3.2-3-3.2v-1.6c2.6 0 4.6 2.1 4.6 4.8ZM101.7 381.6c-.9 0-1.6.7-1.6 1.6 0 .9.7 1.6 1.6 1.6v-3.2Z&quot; fill=&quot;#fff&quot; /&gt;&lt;/g&gt;&lt;g class=&quot;chart&quot;&gt;&lt;path class=&quot;graph-bg&quot; d=&quot;M210 40a160 160 0 0 1 0 320 160 160 0 0 1 0-320&quot; /&gt;&lt;path class=&quot;graph&quot; stroke-dasharray=&quot;calc(10.05 * ',
<span class="lineNum">     335 </span>            :       stroke,
<span class="lineNum">     336 </span>            :       rectangle,
<span class="lineNum">     337 </span>            :       risk,
<span class="lineNum">     338 </span>            :       riskDetail
<span class="lineNum">     339 </span>            :     );
<span class="lineNum">     340 </span>            :   }
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            :   /**
<a name="343"><span class="lineNum">     343 </span>            :    * @dev svg background</a>
<span class="lineNum">     344 </span>            :    */
<span class="lineNum">     345 </span>            :   function _renderBackground(string memory color) internal pure returns (string memory svg) {
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     svg = string.concat(</span>
<span class="lineNum">     347 </span>            :       '&lt;/g&gt;&lt;/g&gt;&lt;defs&gt;&lt;radialGradient id=&quot;gradient&quot; cx=&quot;0&quot; cy=&quot;0&quot; r=&quot;1&quot; gradientUnits=&quot;userSpaceOnUse&quot; gradientTransform=&quot;rotate(-133.2 301 119) scale(368.295)&quot;&gt;&lt;stop stop-color=&quot;',
<span class="lineNum">     348 </span>            :       color,
<span class="lineNum">     349 </span>            :       '&quot; /&gt;&lt;stop offset=&quot;1&quot; stop-color=&quot;',
<span class="lineNum">     350 </span>            :       color,
<span class="lineNum">     351 </span>            :       '&quot; stop-opacity=&quot;0&quot; /&gt;&lt;/radialGradient&gt;&lt;/defs&gt;&lt;/a&gt;&lt;/svg&gt;'
<span class="lineNum">     352 </span>            :     );
<span class="lineNum">     353 </span>            :   }
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :   /**
<a name="356"><span class="lineNum">     356 </span>            :    * @dev calculates liquidation risk</a>
<span class="lineNum">     357 </span>            :    */
<span class="lineNum">     358 </span>            :   function _calcRisk(
<span class="lineNum">     359 </span>            :     uint256 ratio,
<span class="lineNum">     360 </span>            :     uint256 liquidationRatio,
<span class="lineNum">     361 </span>            :     uint256 safetyRatio
<span class="lineNum">     362 </span>            :   ) internal pure returns (string memory, string memory) {
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :     if (ratio == 0) return ('NO', '#63676F');</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     if (ratio &lt;= liquidationRatio) return ('LIQUIDATION', '#E45200');</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :     else if (ratio &gt; liquidationRatio &amp;&amp; ratio &lt;= safetyRatio) return ('HIGH', '#E45200');</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :     else if (ratio &gt; safetyRatio &amp;&amp; ratio &lt;= (safetyRatio * 120 / 100)) return ('ELEVATED', '#FCBF3B');</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     else return ('LOW', '#5DBA14');</span>
<span class="lineNum">     368 </span>            :   }
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            :   /**
<a name="371"><span class="lineNum">     371 </span>            :    * @dev fills circular stroke by percentage of collateral over 100% up to 200%</a>
<span class="lineNum">     372 </span>            :    */
<span class="lineNum">     373 </span>            :   function _calcStroke(uint256 ratio) internal pure returns (string memory) {
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     if (ratio == 0) return '0';</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     if (ratio &lt;= 100 || ratio &gt;= 200) return '100';</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     else return (ratio - 100).toString();</span>
<span class="lineNum">     377 </span>            :   }
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span>            :   /**
<a name="380"><span class="lineNum">     380 </span>            :    * @dev converts uint from wei fixed-point to ether floating-point format</a>
<span class="lineNum">     381 </span>            :    */
<span class="lineNum">     382 </span>            :   function _floatingPoint(uint256 num) internal pure returns (uint256 left, uint256 right) {
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     left = num / 1e18;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     uint256 expLeft = left * 1e18;</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     uint256 expRight = num - expLeft;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     right = expRight / 1e14; // format to 4 decimal places</span>
<span class="lineNum">     387 </span>            :   }
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :   /**
<a name="390"><span class="lineNum">     390 </span>            :    * @dev parses number</a>
<span class="lineNum">     391 </span>            :    */
<span class="lineNum">     392 </span>            :   function _parseNumber(uint256 left, uint256 right) internal pure returns (string memory) {
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     if (left &gt; 0) {</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :       return string.concat(left.toString(), '.', right.toString());</span>
<span class="lineNum">     395 </span>            :     } else {
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :       return string.concat('0.', right.toString());</span>
<span class="lineNum">     397 </span>            :     }
<span class="lineNum">     398 </span>            :   }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            :   /**
<a name="401"><span class="lineNum">     401 </span>            :    * @dev parses comma-separeted number</a>
<span class="lineNum">     402 </span>            :    */
<span class="lineNum">     403 </span>            :   function _parseNumberWithComma(uint256 left, uint256 right) internal pure returns (string memory) {
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     if (left &gt; 0) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :       return string.concat(_commaFormat(left), '.', right.toString());</span>
<span class="lineNum">     406 </span>            :     } else {
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :       return string.concat('0.', right.toString());</span>
<span class="lineNum">     408 </span>            :     }
<span class="lineNum">     409 </span>            :   }
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span>            :   /**
<a name="412"><span class="lineNum">     412 </span>            :    * @dev adds commas every 3 digits</a>
<span class="lineNum">     413 </span>            :    */
<span class="lineNum">     414 </span>            :   function _commaFormat(uint256 source) internal pure returns (string memory) {
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     string memory result = '';</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     uint128 index;</span>
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :     while (source &gt; 0) {</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :       uint256 part = source % 10; // get each digit</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       bool isSet = index != 0 &amp;&amp; index % 3 == 0; // request set glue for every additional 3 digits</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :       result = _concatWithComma(result, part, isSet);</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :       source = source / 10;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :       index += 1;</span>
<span class="lineNum">     425 </span>            :     }
<span class="lineNum">     426 </span>            : 
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     return result;</span>
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            :   /**
<a name="431"><span class="lineNum">     431 </span>            :    * @dev concats with comma</a>
<span class="lineNum">     432 </span>            :    */
<span class="lineNum">     433 </span>            :   function _concatWithComma(string memory base, uint256 part, bool isSet) internal pure returns (string memory) {
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :     string memory stringified = part.toString();</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     string memory glue = ',';</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     if (!isSet) glue = '';</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     return string(abi.encodePacked(stringified, glue, base));</span>
<span class="lineNum">     439 </span>            :   }
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            :   /**
<a name="442"><span class="lineNum">     442 </span>            :    * @dev converts timestamp to human readable date and time format</a>
<span class="lineNum">     443 </span>            :    */
<span class="lineNum">     444 </span>            :   function _formatDateTime(uint256 timestamp) internal pure returns (string memory) {
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     (uint256 year, uint256 month, uint256 day, uint256 hour, uint256 minute,) = timestamp.timestampToDateTime();</span>
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     string memory _month;</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     if (month == 1) _month = 'Jan';</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :     else if (month == 2) _month = 'Feb';</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :     else if (month == 3) _month = 'Mar';</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     else if (month == 4) _month = 'Apr';</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     else if (month == 5) _month = 'May';</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :     else if (month == 6) _month = 'Jun';</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     else if (month == 7) _month = 'Jul';</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     else if (month == 8) _month = 'Aug';</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     else if (month == 9) _month = 'Sep';</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     else if (month == 10) _month = 'Oct';</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     else if (month == 11) _month = 'Nov';</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :     else _month = 'Dec';</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     return string.concat(</span>
<span class="lineNum">     462 </span>            :       _month, ' ', day.toString(), ', ', year.toString(), ' ', _formatTime(hour), ':', _formatTime(minute), ' UTC'
<span class="lineNum">     463 </span>            :     );
<span class="lineNum">     464 </span>            :   }
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span>            :   /**
<a name="467"><span class="lineNum">     467 </span>            :    * @dev zero pads single digits</a>
<span class="lineNum">     468 </span>            :    */
<span class="lineNum">     469 </span>            :   function _formatTime(uint256 time) internal pure returns (string memory) {
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     if (time &lt; 10) return string.concat('0', time.toString());</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     else return time.toString();</span>
<span class="lineNum">     472 </span>            :   }
<span class="lineNum">     473 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
